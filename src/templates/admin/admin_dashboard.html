<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
    <header>
        <span class="icon" onclick="toggleMenu()"><i class="fas fa-bars"></i></span>
        <span class="header-title">Analytics</span>
        <span class="icon"><i class="fas fa-user-shield"></i></span>
    </header>

    <div class="toolbar" style="justify-content: flex-start; gap: 15px;">
        <label style="color:var(--text-muted); font-weight:600;"><i class="fas fa-filter"></i> Filter Year:</label>
        <form action="{{ url_for('admin_dashboard') }}" method="GET">
            <select name="year" class="form-control" onchange="this.form.submit()" style="width: auto; padding: 8px 15px;">
                <option value="All">All Time</option>
                {% for y in years %}
                    <option value="{{ y }}" {% if year_filter == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <div class="dashboard-grid">
        <div class="chart-box">
            <h3 style="margin-bottom: 20px; color: var(--primary);">Papers Published Annually</h3>
            <canvas id="annualChart"></canvas>
            <button class="btn btn-blue" style="margin-top: 20px; width:100%;" onclick="window.print()">
                <i class="fas fa-file-pdf"></i> Generate Report
            </button>
        </div>

        <div>
            <div class="chart-box" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px; color: var(--accent);">Publication Types</h3>
                <div style="height: 250px; display:flex; justify-content:center;">
                    <canvas id="typeChart"></canvas>
                </div>
            </div>

            <div class="chart-box">
                <h3 style="margin-bottom: 20px; color: #10b981;">Top 5 Author Productivity</h3>
                <canvas id="authorChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        const annualData = {{ annual | tojson }};
        const typeData = {{ types | tojson }};
        const authorData = {{ authors | tojson }};

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

        new Chart(document.getElementById('annualChart'), {
            type: 'bar',
            data: {
                labels: annualData.labels,
                datasets: [{ label: 'Papers', data: annualData.data, backgroundColor: '#3b82f6', borderRadius: 4 }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: typeData.labels,
                datasets: [{ data: typeData.data, backgroundColor: ['#f59e0b', '#ef4444', '#10b981', '#3b82f6'], borderWidth: 0 }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        new Chart(document.getElementById('authorChart'), {
            type: 'bar',
            indexAxis: 'y',
            data: {
                labels: authorData.labels,
                datasets: [{ label: 'Papers', data: authorData.data, backgroundColor: '#10b981', borderRadius: 4 }]
            }
        });
    </script>
</body>
</html>